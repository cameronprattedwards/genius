var genius = {}; !function () { !function () { genius.utils = { cases: { camelObject: function (e) { var t = {}; for (var n in e) { var r = e[n]; t[genius.utils.cases.pascalToCamel(n)] = "object" == typeof r ? genius.utils.cases.camelObject(r) : r } return t }, isCapitalized: function (e) { return /[A-Z]/.test(e.charAt(0)) }, pascalToCamel: function (e) { return e.charAt(0).toLowerCase() + e.substr(1) } }, trim: function (e) { return e.replace(/^\s+/, "").replace(/\s+$/, "") }, except: function (e, t) { var n = {}; for (var r in e) genius.utils.contains(t, r) || (n[r] = e[r]); return n }, random: function (e, t) { return Math.random() * (t - e) + e }, map: function (e, t) { for (var n = [], r = 0; r < e.length; r++) n[r] = t.call(this, e[r]); return n }, isNullOrUndefined: function (e) { return "undefined" == typeof e || "object" == typeof e && !e }, trace: function (e) { for (var t = arguments.callee.caller, n = 0; e > n; n++) t = t.arguments.callee.caller; console.log(t.toString()) }, partial: function (e) { return function () { return e.apply(this, genius.utils.toArray(arguments).slice(1)) } }, toArray: function (e) { for (var t = [], n = 0; n < e.length; n++) t.push(e[n]); return t }, accessor: function (e) { return function () { return arguments.length && (e = arguments[0]), e } }, extend: function (e, t) { for (var n in t) e[n] = t[n] }, contains: function (e, t) { return -1 !== genius.utils.indexOf(e, t) }, indexOf: function (e, t) { if (Array.prototype.indexOf) return Array.prototype.indexOf.call(e, t); for (var n = 0; n < e.length; n++) if (e[n] === t) return n; return -1 }, once: function (e) { var t, n = !1, r = function () { return n || (n = !0, t = e.apply(this, arguments)), t }; return r } } }(), function () { var e = function () { this.ajax = { transformToCamelCase: genius.utils.accessor(!1), parseJson: genius.utils.accessor(function (e) { return genius.config.ajax.parseJs().call(this, JSON.parse(e)) }), parseJs: genius.utils.accessor(function (e) { return e }), reset: function () { this.transformToCamelCase(!1) } } }; e.prototype = { reset: function (e) { this.types.reset(e), this.ajax.reset(e) } }, genius.config = new e }(), function () { function e(e, t, n) { this.singleton = function () { n[e] = genius.utils.once(t) }, this.service = function () { }, this.value = t } function t(e) { this.service = function () { return e.value = e, e }, this.singleton = function () { var t = genius.utils.once(e); return t.value = t, t }, this.value = e } function n() { } function r() { this.kernel = new i(this), this.modules = new n; this.kernel.add(this.modules.realDataModule) } function i(e) { var n = []; this.add = function (t) { if (!genius.utils.contains(n, t)) for (var i in t) genius.utils.contains(r.reservedKeywords, i) || (e[i] = t[i].value) }, this.dependency = function (e) { return new t(e) }, this.wipe = function (t) { for (var n in t) genius.utils.contains(r.reservedKeywords, n) || e[n] != t[n].value || delete e[n] }, this.reset = function () { this.wipe() } } Object.reservedKeywords = function () { var e = {}, t = []; for (var n in e) t.push(n); return t }(), n.prototype = { register: function (e, t) { this[e] = t } }, n.reservedKeywords = ["register"].concat(Object.reservedKeywords), r.prototype = { set: function (t, n) { return this[t] = n, new e(t, n, this) } }, r.reservedKeywords = ["kernel", "modules", "RouteProvider"].concat(Object.reservedKeywords), genius.box = new r }(); var e = !0, t = !1; !function () { function r() { function e(e) { if (e instanceof Date) return e; var t = /^\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}\.\d{3}Z$/; if ("string" == typeof e && t.test(e.replace(/^"/, "").replace(/$"/, ""))) { e = genius.utils.trim(e.replace(/[^\d]/g, " ")); var n = genius.utils.map(e.split(/\s+/), parseInt); return new Date(n[0], n[1] - 1, n[2], n[3], n[4], n[5]) } return e } this.bool = new i(!1, !1), this.string = new i(!1, ""), this.date = new i(!0, function () { return new Date }, e, e, function (e) { return e.toISOString() }), this.number = new i(!1, 0), this.dynamic = new i(!0, null), this.custom = new i(!0, null, function (e) { return e }, function (e, t) { if (e instanceof t) return e; var n = new t(e); for (var r in e) n[r] || (n[r] = genius.types.dynamic().getInstance().initialize(e[r]).accessor()); return n }) } function i(e, t, n, r, i) { this.nullable = genius.utils.accessor(e), this.defaultTo = genius.utils.accessor(t), this.parseJs = genius.utils.accessor(n || d), this.parseInit = genius.utils.accessor(r || d), this.toQuery = genius.utils.accessor(i || d); this.parseJs(); this.parseJson = genius.utils.accessor(); var s = [this.nullable(), this.defaultTo(), this.parseJs(), this.parseJson(), this.parseInit()]; this.reset = function () { this.nullable(s[0]), this.defaultTo(s[1]), this.parseJs(s[2]), this.parseJson(s[3]), this.parseInit(s[4]) } } function s(e) { e = e || {}, this.defaultSpecified = e.hasOwnProperty("defaultTo"), this.nullableSpecified = e.hasOwnProperty("nullable"), this.defaultTo = "function" == typeof e.defaultTo ? e.defaultTo : (function () { return e.defaultTo }) || function () { }, this.toQuery = e.toQuery, this.nullable = !!e.nullable, this.parseInit = e.parseInit, this.parseJs = e.parseJs } function o(e, t) { if (t.defaultSpecified) return t.defaultTo(); var n = genius.config.types[e].defaultTo(); return "function" == typeof n ? n() : n } function u(e, t, n) { if (!(typeof e == t || n && genius.utils.isNullOrUndefined(e))) throw new TypeError("Value must be of type " + t + (n ? ", null, or undefined" : "")) } function a(e, t, n) { if (!(e instanceof t || n && genius.utils.isNullOrUndefined(e))) throw new TypeError("Value must be of custom type " + t.name + (n ? ", null, or undefined" : "")) } function f(r, i, s, o) { var u = !1, a = r, f = {}, l = function () { if (arguments.length && (arguments[0] = s(arguments[0]), i(arguments[0]), r = arguments[0], r !== a)) { e && (u = !0); for (var t in f) f[t].call(this, r, a) } return r }, c = 0; return genius.utils.extend(l, { subscribe: function (e) { return f[c] = e, c++ }, unsubscribe: function (e) { delete f[e] }, isDirty: function () { return arguments.length && t && (u = arguments[0]), u }, throwIt: function () { i(r) }, toQuery: function () { return o.call(this, r) } }), l.isAccessor = !0, l } function l(e, t, n) { function r(n) { return e.parseJs ? e.parseJs.call(window, n) : genius.config.types[t].parseJs().call(window, n) } var i = e.nullableSpecified ? e.nullable : genius.config.types[t].nullable(), s = o(t, e); this.default = function () { return s }, this.nullable = function () { return i }, u(s, n, !0); var a = genius.utils.once(function () { return e.parseInit ? e.parseInit : genius.config.types[t].parseInit() }), l = this; this.initialize = genius.utils.once(function (e) { var t = a().call(window, e); return u(t, n, i), s = t, l }), this.accessor = genius.utils.once(function () { return f(s, function (e) { u(e, n, i) }, r, e.toQuery || genius.config.types[t].toQuery()) }) } function c(e, t, n, r) { var i = e.nullableSpecified ? e.nullable : genius.config.types[n].nullable(), s = o(n, e); this.default = function () { return s }, this.nullable = function () { return i }, a(s, t, !0); var u = genius.utils.once(function () { return e.parseInit ? e.parseInit : genius.config.types[n].parseInit() }), l = function (r) { return e.parseJs ? e.parseJs.call(window, r, t) : r instanceof t ? r : (config = genius.config.types[n]) ? config.parseJs().call(window, r, t) : new t(r) }, c = function (e) { a(e, t, i) }, h = this; this.initialize = genius.utils.once(function (e) { var n = u().call(window, e, t); return c(n), s = n, h }), this.accessor = genius.utils.once(function () { var i = f(s, c, l, e.toQuery || genius.config.types[n].toQuery()); return r && (i.customType = t), i }) } function h(e) { function t(t) { return e.parseJs ? e.parseJs.call(window, t) : genius.config.types.dynamic.parseJs().call(window, t) } function n(e) { if (!r && genius.utils.isNullOrUndefined(e)) throw new TypeError("Dynamic value cannot be null or undefined") } var r = e.nullableSpecified ? e.nullable : genius.config.types.dynamic.nullable(), i = o("dynamic", e); this.default = function () { return i }, this.nullable = function () { return r }; var s = genius.utils.once(function () { return e.parseInit ? e.parseInit : genius.config.types.dynamic.parseInit() }), u = this; this.initialize = genius.utils.once(function (e) { var t = s().call(this, e); return n(t), i = t, u }), this.accessor = genius.utils.once(function () { return f(i, n, t, e.toQuery || genius.config.types.dynamic.toQuery()) }) } function p(e, t, n) { e = new s(e); var r = e.nullableSpecified ? e.nullable : genius.config.types.bool.nullable(), i = o(n, e); u(i, t, !0), this.getInstance = function () { return new l(e, n, t) }, this.nullable = function () { return r }, this.getDefault = function () { return i } } r.permanentProperties = ["bool", "string", "date", "number", "dynamic", "custom", "add", "reset"], r.prototype = { add: function (e, t, n) { n = n || {}; { var r = genius.utils.cases.pascalToCamel(e); this[r] = new i(!0, null, n.parseJs) } genius.types[r] = function () { return { getInstance: function (e) { return new c(new s(e), t, "custom", !0) } } } }, reset: function (e) { var t = e && e.hard; for (var n in this) t && !genius.utils.contains(r.permanentProperties, n) ? delete this[n] : this[n].reset && this[n].reset(); r.call(this) } }; var d = function (e) { return e }; genius.config.types = new r; genius.types = function (e, t) { return { getInstance: function () { return new c(new s(t), e, "custom", !0) }, customType: e } }, genius.utils.extend(genius.types, { collection: function (e) { var t = genius.Collection.extend({ type: e }); return { getInstance: function () { return new t } } }, bool: function (e) { return new p(e, "boolean", "bool") }, string: function (e) { return new p(e, "string", "string") }, number: function (e) { return new p(e, "number", "number") }, dynamic: function (e) { e = new s(e); var t = e.nullableSpecified ? e.nullable : genius.config.types.bool.nullable(), n = o("dynamic", e); return { getInstance: function () { return new h(e) }, nullable: function () { return t }, getDefault: function () { return n } } }, date: function (e) { e = new s(e); var t = e.nullableSpecified ? e.nullable : genius.config.types.date.nullable(), n = o("date", e); return a(n, Date, !0), { getInstance: function () { return new c(e, Date, "date") }, nullable: function () { return t }, getDefault: function () { return n } } } }) }(), function () { function r(r) { function i(e) { var t; if (t = s[e]) for (var n in t) t[n].apply(this, genius.utils.toArray(arguments).slice(1)) } var s = { none: {} }, o = !a, u = f, l = a, c = !1, h = 0; return genius.utils.extend(this, { subscribe: function (e, t) { e = "string" == typeof e ? e : "change", t = "string" == typeof e ? t : e, s[e] || (s[e] = {}), s[e][h++] = t }, unsubscribe: function (e) { var t = !1; for (var n in s) if (s[n][e]) { t = !0, delete s[n][e]; break } return t }, isDirty: function () { return o }, isNew: function () { return u }, isLoading: genius.utils.accessor(l), isDeleted: function () { return c }, $delete: function () { function e() { for (var e in this) this[e] && this[e].isAccessor && delete this[e] } if (i("delete"), u) e.call(this), c = !0; else { var t = genius.box.RouteProvider().createRoute(this.url(), this, !1), n = this; this.isLoading(!0), genius.box.HttpBackend().del(t).done(function () { c = !0, e.call(n) }).always(function () { n.isLoading(!1) }) } return null }, $save: function () { if (c) throw new ReferenceError("You cannot save a deleted resource."); if (o) { var r = genius.box.RouteProvider(), i = r.createRoute(this.url(), this, !1), s = this; this.isLoading(!0), genius.box.HttpBackend()[u ? "post" : "put"](i, this.toJson()).done(function (r) { r = genius.config.ajax.parseJson().call(this, r), e = !1, t = !0; for (var i in r) console.log(i), "favoriteToy" == i && console.log("I'm a toy."), s[i] && s[i].isAccessor && (s[i](r[i]), s[i].isDirty(!1)); e = !0, t = !0, o = !1 }).always(function () { s.isLoading(!1) }) } }, optionsHash: function () { return r } }), function (t) { e && (o = t) } } function i(e) { for (var t in e) "uniqKey" !== t && "url" !== t && (this[t] = e[t]) } function s(e, t, n) { var r = genius.config.ajax.transformToCamelCase(); if (r && genius.utils.cases.isCapitalized(e)) { var i = genius.utils.cases.pascalToCamel(e); return s.call(this, i, t, n), this[e] && (this[e] = this[i]), void 0 } "object" == typeof t && r && (t = genius.utils.cases.camelObject(t)), this[e] && this[e].getInstance ? (this[e] = this[e].getInstance().initialize(t).accessor(), this[e].subscribe(function () { n(!0) })) : this[e] = "function" == typeof t ? t : genius.types.dynamic({ nullable: !0 }).getInstance().initialize(t).accessor() } function o(e, t) { for (var n in e) s.call(this, n, e[n], t); for (var n in this) if ("function" == typeof this[n].getInstance && (this[n] = this[n].getInstance().accessor(), this[n].subscribe(function () { t(!0) })), "function" == typeof this[n].throwIt) try { this[n].throwIt() } catch (r) { throw r } } function u(e) { for (var t = e.split("."), n = this[t[0]], r = 1; r < t.length; r++) { if (!n[t[r]]) return; n = n[t[r]].isAccessor ? n[t[r]]() : n[t[r]] } return n } var a = !1, f = !0, l = !1, c = function () { }; c.prototype = { changedProperties: function () { var e = {}; for (var t in this) this[t].isAccessor && this[t].isDirty() && (e[t] = this[t]()); return e }, properties: function () { var e = {}; for (var t in this) this[t].isAccessor && (e[t] = this[t], e[t]() instanceof c && (e[t] = e[t].properties())); return e }, toJs: function () { var e = {}; for (var t in this) { if (this[t].toJs) e[t] = this[t].toJs(); else { if (!this[t].isAccessor) continue; e[t] = this[t]() } e[t] instanceof c && (e[t] = e[t].toJs()) } return e }, toJson: function () { return JSON.stringify(this.toJs()) } }, c.extend = function (e) { function t(t) { if (e.uniqKey) { var n = u.call(t, e.uniqKey); return n } } var n; if (e.uniqKey && (field = e[e.uniqKey])) { if (!field.nullable()) throw new TypeError("Unique keys must be nullable"); if (!genius.utils.isNullOrUndefined(field.getDefault())) throw new TypeError("Unique keys must default to undefined or null") } var s = {}, c = "function" == typeof e.url ? e.url : function () { return e.url || "" }; l = !0; var h = new this; l = !1; for (var p in e) "function" == typeof e[p] && (h[p] = e[p]); h.url = c; var d = function (u) { function f() { var r = t(u || {}); if (r) { var f = s[r]; if (f) return o.call(f, u), f; s[r] = this } i.call(this, e), a || o.call(this, u, n) } return l ? void 0 : ("function" == typeof this.init && this.init.apply(this, arguments), n = r.call(this, u), f.prototype = this, new f) }; return d.prototype = h, d.extend = arguments.callee, d.$query = function (e) { e = e || {}; var t = genius.Collection.extend({ type: genius.types(d) }), n = new t, r = genius.box.HttpBackend(), i = genius.box.RouteProvider().createRoute(c(), e); return n.$promise = r.get(i).done(function (e) { f = !1; var t = genius.config.ajax.parseJson().call(this, e); n.concat(t), f = !0, n.isLoading(!1) }), n }, d.$get = function (t) { var r = genius.box.HttpBackend(), i = genius.box.RouteProvider().createRoute(c(), t); a = !0, f = !1; var s = new this; for (var u in t) s[u] && s[u].getInstance && (s[u] = s[u].getInstance().initialize(t[u]).accessor()); a = !1, f = !0; var l = n, h = r.get(i).done(function (t) { var n = genius.config.ajax.parseJson().call(this, t); e.parseJs && (n = e.parseJs(n)), o.call(s, n, l) }).done(function () { s.isLoading(!1) }); return s.$promise = h, s }, d }, genius.Resource = c }(), function () { function t(e) { e = e || {}, this.push = function (t) { if (e.type && (t = e.type.getInstance().initialize(t).accessor().call()), e.unique && genius.utils.contains(this, t)) return this.length; var r = e.unique && genius.utils.contains(this, t) ? this.length : Array.prototype.push.call(this, t); return r }, this.concat = function (t) { return e.type && (t = genius.utils.map(t, function (t) { return e.type.getInstance().initialize(t).accessor().call() })), Array.prototype.push.apply(this, t) }, this.removeAll = function () { this.splice(0) }, this.remove = function (e) { for (var t; -1 !== (t = genius.utils.indexOf(this, e)) ;) this.splice(t, 1) } } t.prototype = []; var r = !1; t.extend = function (t) { function i(e) { if (!r) { e = e || {}, "function" == typeof this.init && this.init.apply(this, arguments), e.type && (o = e.type), e.unique && (u = e.unique), this.isLoading = genius.utils.accessor(!0), this.type = function () { return o }, this.isDirty = genius.utils.accessor(!1); var t = {}, n = 0; this.subscribe = function (e) { return t[n] = e, n++ }, this.fire = function () { } } } t = t || {}, r = !0; var s = new this; r = !1; var o = t.type, u = t.unique; s.toJs = function () { return genius.utils.map(this, function (e) { return e.toJs ? e.toJs() : e }).slice(0, this.length) }, s.initialize = function (t) { return e = !1, this.concat(t), e = !0, this }, s.accessor = function () { var e = this, t = function () { return arguments.length && (e.removeAll(), e.concat(arguments[0]), e.isDirty(!0)), e }; return t.isAccessor = !0, t.subscribe = this.subscribe, t.isDirty = this.isDirty, t.toJs = this.toJs.bind(this), t }, s.push = function (e) { if (o && (e = o.getInstance().initialize(e).accessor().call()), u && genius.utils.contains(this, e)) return this.length; if (e instanceof genius.Resource) { var t = this; e.subscribe("delete", function () { t.remove(e) }) } var n = u && genius.utils.contains(this, e) ? this.length : Array.prototype.push.call(this, e); return n }, (concat = Array.prototype.concat) && (s.concat = function (e) { return o && (e = genius.utils.map(e, function (e) { if (e = o.getInstance().initialize(e).accessor().call(), e instanceof genius.Resource) { var t = this; e.subscribe("delete", function () { t.remove(e) }) } return e })), Array.prototype.push.apply(this, e) }); for (var a in t) "function" == typeof t[a] && "type" !== a && (s[a] = t[a]); return i.prototype = s, i.extend = arguments.callee, i }, genius.Collection = t }(), function () { function e() { function e() { this.done = function (e) { if ("function" == typeof e) { if ("resolved" == s) return e.apply(this, arguments), this; n.push(e) } return this }, this.fail = function (e) { if ("function" == typeof e) { if ("rejected" == s) return e.apply(this, arguments), this; r.push(e) } return this }, this.always = function (e) { if ("function" == typeof e) { if ("pending" !== s) return e.apply(this, arguments), this; i.push(e) } return this }, this.state = function () { return s } } function t(e, t) { for (var n = 0; n < e.length; n++) e[n].apply(this, t); for (var n = 0; n < i.length; n++) i[n].apply(this, t) } var n = [], r = [], i = [], s = "pending"; this.resolve = function () { s = "resolved", t.call(this, n, arguments) }, this.reject = function () { s = "rejected", t.call(this, r, arguments) }; var o = new e; this.promise = function () { return o } } e.prototype = { done: function () { return this.promise().done.apply(this, arguments) }, fail: function () { return this.promise().fail.apply(this, arguments) }, always: function () { return this.promise().always.apply(this, arguments) } }, genius.deferred = function () { return new e } }(), function () { function e(e, t, n) { this.toReturn = function (r) { e.expectations[t + "-" + n] = r } } function t() { this.expectations = {}, this.pendingRequests = {} } t.prototype = function () { function t(e, t) { if (!this.expectations[e + "-" + t]) throw new ReferenceError("Unexpected request for " + t); var n = genius.deferred(); return this.pendingRequests[e + "-" + t] = n, n.promise() } return { get: function (e) { return t.call(this, "get", e) }, put: function (e) { return t.call(this, "put", e) }, post: function (e) { return t.call(this, "post", e) }, flush: function () { for (var e in this.pendingRequests) this.pendingRequests[e].resolve(this.expectations[e]), delete this.pendingRequests[e] }, expectGet: function (t) { return new e(this, "get", t) }, expectPost: function (t) { return new e(this, "post", t) }, expectPut: function (t) { return new e(this, "put", t) }, expectDelete: function (t) { return new e(this, "delete", t) } } }(), genius.box.set("FakeHttpBackend", function () { return new t }).singleton() }(), function () { function e() { } function t(e, t, n) { var r = genius.deferred(), i = genius.box.XHR(); return i.open(t, e, !0), i.setRequestHeader("Accepts", "application/json"), i.setRequestHeader("Content-type", "application/json"), i.onreadystatechange = function () { console.log("state change: ", i.readyState, i.status), 4 == i.readyState && 200 == i.status && r.resolve(i.responseText) }, i.send(n), r.promise() } e.prototype = { get: function (e) { return t(e, "GET") }, put: function (e, n) { return t(e, "PUT", n) }, post: function (e, n) { return t(e, "POST", n) }, del: function (e, n) { return t(e, "DELETE", n) } }, genius.box.set("RealHttpBackend", function () { return new e }) }(), function () { function e(e) { var t = !1, n = this, r = function () { e.call().always(function () { t && setTimeout(r, n.buffer()) }) }; this.start = function () { t || (t = !0, r()) }, this.stop = function () { t = !1 }, this.buffer = genius.utils.accessor(0) } genius.box.set("AsyncQueue", function () { return new e }).service() }(), function () { function e(e) { var t = []; for (var n in e) t.push(n + "=" + (e[n].toQuery ? e[n].toQuery() : e[n])); return t.length ? "?" + t.join("&") : "" } function t() { } t.prototype = { createRoute: function (t, r, i) { for (var s, o = /\:([^\/\.\-]+)/gi, u = t, a = []; s = o.exec(t) ;) { var f, l = s[1]; f = r[l] ? r[l].isAccessor && r[l]() ? r[l]() : "function" != typeof r[l] ? r[l] : "" : "", u = u.replace(s[0], f), a.push(s[1]) } return /\/$/.test(u) && (u = u.substr(0, u.length - 1)), i !== !1 && (u += e(genius.utils.except(r instanceof genius.Resource ? r.properties() : r, a))), u } }, genius.box.set("RouteProvider", function () { return new t }).singleton() }(), function () { window.XMLHttpRequest ? genius.box.set("XHR", function () { return new XMLHttpRequest }) : window.ActiveXObject && genius.box.set("XHR", function () { return new ActiveXObject("Microsoft.XMLHTTP") }) }(), function () { genius.box.modules.register("realDataModule", { HttpBackend: genius.box.kernel.dependency(genius.box.RealHttpBackend) }), genius.box.modules.register("testDataModule", { HttpBackend: genius.box.kernel.dependency(genius.box.FakeHttpBackend) }), genius.box.kernel.add(genius.box.modules.realDataModule), genius.config.types.date.parseInit() }() }()